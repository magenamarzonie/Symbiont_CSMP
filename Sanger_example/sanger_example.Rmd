---
title: "example_sanger"
author: "MNitschke"
date: "05/05/2022"
output: html_document
---

```{r}
library(sangerseqR)
library(bioseq)
library(DECIPHER)
library(phangorn)
library(tidyverse)

read_fasta_df <- function(file = ""){
    fasta <- readLines(file)
    ind <- grep(">", fasta)
    s <- data.frame(ind = ind, from = ind + 1, to = c((ind - 
        1)[-1], length(fasta)))
    seqs <- rep(NA, length(ind))
    for (i in 1:length(ind)) {
        seqs[i] <- paste(fasta[s$from[i]:s$to[i]], collapse = "")
    }
    tib <- tibble(label = gsub(">", "", fasta[ind]), 
        sequence = seqs)
    return(tib)
}

write_fasta_df <- function (data, filename) 
{
    fastaLines = c()
    for (rowNum in 1:nrow(data)) {
        fastaLines = c(fastaLines, as.character(paste(">", 
            data[rowNum, "label"], sep = "")))
        fastaLines = c(fastaLines, as.character(data[rowNum, 
            "sequence"]))
    }
    fileConn <- file(filename)
    writeLines(fastaLines, fileConn)
    close(fileConn)
}

dna_to_DNAbin <- function (dna){
  DNAbin <- as_DNAbin(dna)
  names(DNAbin) <- names(dna)
  return(DNAbin)
}
dna_to_DNAStringset <- function(x) 
{
    bioseq:::check_dna(x)
    DNAstr <- DNAStringSet(paste(x))
    names(DNAstr) <- names(x)
    return(DNAstr)
}

DNAStringSet_to_dna <- function(x){
    x_dna <- as_dna(paste(x))
    names(x_dna) <- names(x)
    res <- tibble(label = names(x), sequence = x_dna)
    return(res)
}
```

# Viewing chromatograms

```{r}
ss <- readsangerseq("KK1_F_H07.ab1")
ss_het <- makeBaseCalls(ss, ratio = 0.33)
chromatogram(ss_het,  showcalls = "both")
```

# importing all the forward .fa or .txt files (same thing)

```{r}
f_all <- sort(list.files(path = "../Sanger_example/", pattern = "(_F_|.fa)(?:.+)(_F_|.fa)", full.names = TRUE))
r_all <- sort(list.files(path = "../Sanger_example/", pattern = "(_R_|.fa)(?:.+)(_R_|.fa)", full.names = TRUE))

f_all
r_all

f_all_fasta <- f_all %>%
  map(read_fasta_df) %>% # read in all the files
  reduce(rbind) # reduce with rbind into one dataframe

r_all_fasta <- r_all %>%
  map(read_fasta_df) %>% # read in all the files
  reduce(rbind) # reduce with rbind into one dataframe
```

# apply the trimming parameters to start and end of the sequences (example, remove 10 bases from start and end)

```{r}
f_all_fasta_sub <- f_all_fasta %>%
  mutate(sequence = str_sub(sequence, start = 11, end = -11)) # start = trim + 1, end = trim + 1

r_all_fasta_sub <- r_all_fasta %>%
  mutate(sequence = str_sub(sequence, start = 11, end = -11)) # start = trim + 1, end = trim + 1
```

# convert to format for DECIPHER and reverse complement the reverse sequence

```{r}
f_dss <- f_all_fasta_sub %>%
  deframe() %>%
  as_dna() %>%
  dna_to_DNAStringset()

r_dss <- r_all_fasta_sub %>%
  deframe() %>%
  as_dna() %>%
  dna_to_DNAStringset() %>%
  reverseComplement()

pair_list <- list()
for(i in 1:length(f_dss)){
  ss <- DNAStringSet(c(f_dss[i], r_dss[i]))
  pair_list[[i]] <- ss
}
```

# Align the sample pairs

```{r}
alignment_list <- list()
for(i in 1:length(pair_list)){
  alignment <- AlignSeqs(pair_list[[i]])
  alignment_list[[i]] <- alignment
}
```

# View the alignments

```{r}
palette <- c("A" = "#6bb04a", "G" = "#4e76dd", "C" = "#c89232", "T" = "#d14d4b", "N" = "black", "-" = "white", "K" = "purple")

aligned_df <- data.frame()
for(i in 1:length(alignment_list)){
  a_pair <- alignment_list[[i]] %>% writeXStringSet("temp_file.fasta")
  a_df <- read_fasta_df("temp_file.fasta")
  aligned_df <- rbind(aligned_df, a_df)
}

aligned_plotting <- aligned_df %>%
  mutate(sample_id = str_sub(label, 7, 10)) # create a metadata column that identifies the sample

# Create profile key
key <- aligned_plotting %>%
  tibble::rownames_to_column(var = "id")

# Create long dataframe for ggplot
long_sequences <- str_split(aligned_plotting$sequence, "") %>%
  reshape2::melt() %>%
  group_by(L1) %>%
  mutate(x = row_number(),
         L1 = as.character(L1)) %>%
  left_join(., key, by = c("L1" = "id")) %>%
  ungroup()

# Plot alignment
ggplot(long_sequences, aes(y = label, x = x)) +
      geom_tile(aes(fill = value), size = 1, name = "base") +
      facet_wrap(~ sample_id, ncol = 1, scales = "free_y") +
      scale_fill_manual(values = palette) +
      theme(aspect.ratio = 0.3,
            axis.title.y = element_blank()) +
      scale_x_continuous(expand = c(0, 0)) +
    xlab("Position")

```

# Create the consensus sequences

```{r}
consensus_df <- list()
for(i in 1:length(alignment_list)){
  a_con <- alignment_list[[i]] %>% ConsensusSequence()
  names(a_con) <- names(alignment_list[[i]])[1]
  consensus_df[[i]] <- a_con
}
```

# Align the consensus sequences

```{r}
aligned_consensus <- AlignSeqs(do.call(c, consensus_df))
writeXStringSet(aligned_consensus, "consensus_sequence_alignment.fasta")
```

# Visualise the alignment

```{r}
final_alignment <- read_fasta_df("consensus_sequence_alignment.fasta") %>%
  mutate(sample_id = str_sub(label, 7, 10)) # create a metadata column that identifies the sample

# Create profile key
final_key <- final_alignment %>%
  tibble::rownames_to_column(var = "id")

# Create long dataframe for ggplot
final_long_sequences <- str_split(final_alignment$sequence, "") %>%
  reshape2::melt() %>%
  group_by(L1) %>%
  mutate(x = row_number(),
         L1 = as.character(L1)) %>%
  left_join(., final_key, by = c("L1" = "id")) %>%
  ungroup()

n1 <- length(unique(final_long_sequences$x))
n2 <- length(unique(final_long_sequences$sample_id))

# Plot alignment
ggplot(final_long_sequences, aes(y = label, x = x)) +
      geom_tile(aes(fill = value), height = 1) +
      scale_fill_manual(values = palette, name = "base") +
      theme(aspect.ratio = 0.3,
            axis.title.y = element_blank()) +
      scale_x_continuous(expand = c(0, 0)) +
   geom_line(data = data.frame(x = c(0, n1) + 0.5, y = rep(2:n2, each = 2) - 0.5),
            aes(x = x, y = y, group = y)) + # Horizonal lines
  xlab("Position")
```

