---
title: "3_Acro_Pocillo_PCA"
author: "Magena Marzonie"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries 
```{r}
library(vegan)
library(ggsci)
library(tidyverse)
library(kmer)
library(phangorn)
library(GUniFrac)
library(ggtree)
library(patchwork)
library(bioseq)
library(ape)
library(Biostrings)
select = dplyr::select
```

#Load data 
```{r}
#load environmental data 
load("Data/SiteDisturbanceHistory_DHW.RData")
load("Data/SiteDisturbanceHistory_DHW.RData")

#load seq data from 2_UPGMA
load("Data/du_acro.RData")
load("Data/du_poci.RData")
load("Data/du_pver.Rdata")
load("Data/du_pmea.Rdata")
load("Data/du_punk.Rdata")
load("Data/full_meta.RData")
load("Data/full_meta2.RData")
```

#Data Wrangle 
```{r}
#Combining symbiont unifrac distances and environmental metadata
full_meta2 = full_meta2 %>% 
  mutate(DHW = as.numeric(DHW),
         Reef = as.factor(Reef.x),
         Site = as.factor(Site),
         Exposure = as.factor(Exposure),
         catBleaching = as.factor(catBleaching),
         Aspect = as.factor(Aspect))
```



```{r}
car::vif(lm(1:nrow(adonis_meta_pver) ~ GPS_S  + Aspect + Exposure + catBleaching + Depth + DHW3, data=adonis_meta_pver))

car::vif(lm(1:nrow(adonis_meta_pmea) ~ GPS_S  + Aspect + Exposure + catBleaching + Depth + DHW3, data=adonis_meta_pmea))

car::vif(lm(1:nrow(adonis_meta_punk) ~ GPS_S + Aspect + Exposure + catBleaching + Depth + DHW3, data=adonis_meta_punk))

car::vif(lm(1:nrow(adonis_meta_acro) ~ GPS_S + Aspect + Exposure + catBleaching + Depth + DHW3, data=adonis_meta_acro))

#variability in SST (varSST) has collinearity with GPS_S (VIF score > 3) for most of the species (p. mea and p. unk), so will be removed from the adonis model)
```



# ----------------------------------------------------------
Permanova/ PCoA: **Pocillopora verrucosa**
# ----------------------------------------------------------

## a Permanova/ Betadisper 
```{r}
#importing unifrac distances for analysis 
dist_pver <- as.dist(du_pver, diag = FALSE)
dim(du_pver)

adonis_meta_pver <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, catBleaching, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9, varSST) %>%
  filter(plate_position %in% rownames(du_pver)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

#dbRDA with all factors 
ord_pver <- dbrda(dist_pver ~ GPS_S + DHW3 + catBleaching + Depth, data = adonis_meta_pver, permutations = 9999)
anova(ord_pver, by = 'margin')   

#ord_pver_cap <- capscale(dist_pver ~ GPS_S + catBleaching + Exposure + Depth + GPS_E + DHW3 + DHW6 + varSST, data = adonis_meta_pver, permutations = 9999)
#anova(ord_pver_cap, by = 'margin')   

#ordination plot 
ordplot_pver <- plot(ord_pver)
```


# ----------------------------------------------------------
Permanova/ PCoA: **Pocillopora meandrina**
# ----------------------------------------------------------

## a Permanova/ Betadisper 
```{r}
dist_pmea <- as.dist(du_pmea, diag = FALSE)
dim(du_pmea)

adonis_meta_pmea <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, catBleaching, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9, varSST) %>%
  filter(plate_position %in% rownames(du_pmea)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

#dbRDA with all factors 
ord_pmea <- dbrda(dist_pmea ~ GPS_S + DHW3 + catBleaching + Depth, data = adonis_meta_pmea, permutations = 9999)
anova(ord_pmea, by = 'margin')   

#ordination plot 
ordplot_pmea <- plot(ord_pmea)
```


# ----------------------------------------------------------
Permanova/ PCoA: **Pocillopora unknown**
# ----------------------------------------------------------


```{r}
dist_punk <- as.dist(du_punk, diag = FALSE)
dim(du_punk)

adonis_meta_punk <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, catBleaching, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9, varSST) %>%
  filter(plate_position %in% rownames(du_punk)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

#dbRDA with all factors 
ord_punk <- dbrda(dist_punk ~ GPS_S + DHW3 + catBleaching + Depth, data = adonis_meta_punk, permutations = 9999)
anova(ord_punk, by = 'margin')   

#ordination plot 
ordplot_punk <- plot(ord_punk)
```

# ----------------------------------------------------------
Permanova/ PCoA: **Acropora humilis**
# ----------------------------------------------------------

```{r}
dist_acro <- as.dist(du_acro, diag = FALSE)
dim(du_acro)

adonis_meta_acro <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, catBleaching, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9, varSST) %>%
  filter(plate_position %in% rownames(du_acro)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

#dbRDA with all factors 
ord_acro <- dbrda(dist_acro ~ GPS_S + DHW3 + catBleaching + Depth, data = adonis_meta_acro, permutations = 9999)
anova(ord_acro, by = 'margin')   

#ordination plot 
ordplot_acro <- plot(ord_acro)
```





```{r}
#dbrda 
ord <- dbrda(dist_pver ~ Exposure + Depth + DHW3 + GPS_S, data = adonis_meta_pver, permutations = 9999)
anova(ord, by = 'margin')    #indicates the marginal effect after controlling for the other variables. 
#anova(ord, by = 'terms')     #analyses terms added sequentially. You get different significance because the terms are correlated, so which one goes into the model first determines how much variation is left to be explained by the second, or third... 

#capscale function for comparison 
ord2 <- capscale(dist_pver ~ Exposure + Depth + DHW3 + GPS_S, data = adonis_meta_pver, permutations = 9999)
anova(ord2, by = 'margin')

plot(ord2)

#Depth is sometimes significant, depending on the order. Exposure and Aspect never significant. 

ord3 <- dbrda(dist_pver ~ DHW3 * GPS_S, data = adonis_meta_pver, permutations = 9999)
anova(ord3, by = 'margin')



car::vif(lm(1:nrow(adonis_meta_pver) ~ GPS_S + Aspect + Exposure + catBleaching + Depth + DHW3, data=adonis_meta_pver))
#use GVIF ^(1/2*df) to make comparable across dimensions, where df is the number of coefficients in the subset. This reduces GVIF to a linear measure, 

#                   GVIF Df GVIF^(1/(2*Df))
# GPS_S         6.142029  1        2.478312
# Aspect       53.862659  6        1.394036
# Exposure     22.149506  3        1.675820
# catBleaching  1.588898  5        1.047393
# Depth         1.535612  1        1.239198
# DHW           7.904910  1        2.811567


#               Df SumsOfSqs  MeanSqs F.Model      R2 Pr(>F)   
# GPS_S          1    0.0840 0.083967 3.15665 0.02039 0.0059 **
# Aspect         6    0.1942 0.032373 1.21703 0.04717 0.1731   
# Exposure       3    0.0955 0.031827 1.19648 0.02319 0.2357   
# catBleaching   5    0.1310 0.026200 0.98497 0.03181 0.4791   
# Depth          1    0.0325 0.032517 1.22243 0.00790 0.2527   
# DHW            1    0.0164 0.016385 0.61599 0.00398 0.7722   
# Residuals    134    3.5644 0.026600         0.86557          
# Total        151    4.1180                  1.00000          
 

beta <- betadisper(dist_pver, adonis_meta_pver$GPS_S)
anova(beta)
# Analysis of Variance Table
# 
# Response: Distances
#            Df  Sum Sq   Mean Sq F value Pr(>F)
# Groups     21 0.09242 0.0044012  0.7705 0.7504
# Residuals 130 0.74258 0.0057121 

plot(beta)

res.cap <- capscale(dist_pver ~ GPS_S + Aspect + Exposure + catBleaching + Depth + DHW, data = adonis_meta_pver)
(fit <- envfit(res.cap, adonis_meta_pver %>% select(GPS_S, Aspect, Exposure, catBleaching, Depth, DHW), perm = 999))

scores(fit, "vectors")
plot(res.cap)
plot(fit)
plot(fit, p.max = 0.05, col = "red")

res.cap <- capscale(dist_pver ~ GPS_S, data = adonis_meta_pver)

car::vif(res.cap)

permutest(res.cap)

res.ad
res.cap
plot(res.cap)
RsquareAdj(res.cap)

pca <- rda(elementome_rda)
eig <- eigenvals(res.cap)
eig <- data.frame(summary(eig))

test_pver <- betadisper(as.dist(du_pver), adonis_meta_pver$Reef)
plot(test_pver)
anova(test_pver)
```


```{r}
dist_pmea <- as.dist(du_pmea, diag = FALSE)

dim(du_pmea)

adonis_meta_pmea <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, catBleaching, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9) %>%
  filter(plate_position %in% rownames(du_pmea)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

#dbrda 
ord <- dbrda(dist_pmea ~ Exposure + Depth + DHW3 + GPS_S, data = adonis_meta_pmea, permutations = 9999)
anova(ord, by = 'margin')    #indicates the marginal effect after controlling for the other variables. 
anova(ord, by = 'terms')     #analyses terms added sequentially. You get different significance because the terms are correlated, so which one goes into the model first determines how much variation is left to be explained by the second, or third... 

#capscale function for comparison 
ord2 <- capscale(dist_pmea ~  DHW3 + GPS_S + Exposure + Depth, data = adonis_meta_pmea, permutations = 9999)
anova(ord2, by = 'margin')

#Depth is sometimes significant, depending on the order. Exposure and Aspect never significant. 


car::vif(lm(1:nrow(adonis_meta_pmea) ~ GPS_S + Aspect + Exposure + catBleaching + Depth + DHW3, data=adonis_meta_pmea))
```


```{r}
dist_acro <- as.dist(du_acro, diag = FALSE)

dim(du_acro)

adonis_meta_acro <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, catBleaching, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9) %>%
  filter(plate_position %in% rownames(du_acro)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

#dbrda 
ord <- dbrda(dist_acro ~ Exposure + Depth + DHW3 + GPS_S, data = adonis_meta_acro, permutations = 9999)
anova(ord, by = 'margin')    #indicates the marginal effect after controlling for the other variables. 
anova(ord, by = 'terms')     #analyses terms added sequentially. You get different significance because the terms are correlated, so which one goes into the model first determines how much variation is left to be explained by the second, or third... 

#capscale function for comparison 
ord2 <- capscale(dist_acro ~  DHW3 + GPS_S + Exposure + Depth, data = adonis_meta_acro, permutations = 9999)
anova(ord2, by = 'margin')

#Depth is sometimes significant, depending on the order. Exposure and Aspect never significant. 


car::vif(lm(1:nrow(adonis_meta_acro) ~ GPS_S + Aspect + Exposure + catBleaching + Depth + DHW3, data=adonis_meta_acro))
```



##b. PCoA 
```{r}
pcoares_pver <- pcoa(dist_pver)
            
pcoa_df_pver <- as.data.frame(pcoares_pver$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  dplyr::select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_pver %>% rownames_to_column(var = "plate_position")) %>%
    mutate(Reef = fct_relevel(Reef, c("Osprey", "Bougainville", "Moore", "Willis", "Holmes", "Chilcott", "Herald", "Lihou", "Flinders", "Marion", "Frederick", "Saumarez", "Wreck")))


ggplot(pcoa_df_pver, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Reef), shape = 21, size = 3, alpha = 0.8) +
  facet_wrap(~Reef) +
  ggalt::geom_encircle(aes(group = Reef, fill = Reef), s_shape=1, expand=0, alpha = 0.1) 

#ggsave("fig/pcoa_df_poci.png", dpi =300, width=8, height=8, units = "cm")

```


## a Permanova/ Betadisper 
```{r}
#importing unifrac distances for analysis 
dist_pmea <- as.dist(du_pmea, diag = FALSE)

dim(du_pmea)

# Sanity check
full_meta2$plate_position %in% rownames(du_pmea)

adonis_meta_pmea <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9) %>%
  filter(plate_position %in% rownames(du_pmea)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res <- adonis(dist_pmea ~ Reef, data = adonis_meta_pmea)

test_pmea <- betadisper(as.dist(du_pmea), adonis_meta_pmea$Reef)
plot(test_pmea)
anova(test_pmea)
```


```{r}
#dbRDA capscale function 
capscale(as.dist(du_pver) ~ DHW3, data = adonis_meta_pver)
```



```{r}
#the order of sequential terms: statistical significance calculated based on based on permuting distance matrix. Permutation will lead to power loss in testing effect of a covariate of interest while adjusting for other coveriates (confounders). Power loss is more evident when the confounders effects are strong. 

#before running adonis, we need to see which are the strongest drivers ? And then run a few tests with additive and interacting covariates 

adonis3(as.dist(du_pmea) ~ DHW6, data = adonis_meta_pmea)
adonis3(as.dist(du_pmea) ~ GPS_S + GPS_E + DHW3 + DHW6 , data = adonis_meta_pmea)
```



#now P. unknown adonis
```{r}

```





## c. RDA P.ver

### MDS to explore the data
Let's quickly explore the data to see if any major patterns stand out.

*Ideally, I think we should standardise the data in to proportion for each sample before picking the most abudant sequences*
```{r}
# Load community matrix
load(file = "pver.community.matrix.RData")

my.symbionts = pver.community.matrix %>% summarise_all(mean, na.rm = T) %>% 
  gather() %>% 
  arrange(desc(value)) %>% 
  #ggplot(aes(y = value, x = key)) + geom_col()
  top_n(30) %>% pull(key)

# hellinger transform the species dataset: gives low weights to rare species 
spe.hel <- decostand(pver.community.matrix %>% select(all_of(my.symbionts)), "hellinger")

# Calculate distance matrix
bc<-vegdist(spe.hel, method="bray", binary=FALSE) 

# look at an unconstrained ordination first, it is always a good idea to look at both unconstrained and constrained ordinations
# set the seed: to reproduce the same result in the fture

bci.mds<-metaMDS(spe.hel, distance = "bray", k = 2, try = 60)

# extract x and y coordinates from MDS plot into new dataframe, so you can plot with ggplot 
MDS_xy <- data.frame(bci.mds$points) %>% 
  rownames_to_column() %>% 
  left_join(adonis_meta_pver %>% rownames_to_column(), by = "rowname") %>% 
  gather(key = variable, value = value, -c(rowname, MDS1, MDS2)) %>% 
  mutate(variable = as.factor(variable))
bci.mds$stress # 0.1241412

# plot
ggplot(MDS_xy, aes(MDS1, MDS2, col = value)) + 
  facet_wrap(~variable) +
  geom_point(alpha = .5) + 
  theme_bw() + 
  ggtitle(round(bci.mds$stress,2)) +
  theme(legend.position = "none")

```
It's not obsvious what might be driving community structure in these samples. 
Let's see if and of the predictors come out significant


```{r}
mdsvectors <- data.frame(bci.mds$species) %>% add_rownames("Species") %>%
  mutate(distance = sqrt((MDS1)^2 + (MDS2)^2))
  
mdspoints <- data.frame(scores(bci.mds))

ggplot()+
    geom_point(data=mdspoints, aes(x=NMDS1, y=NMDS2), col="white")+
    geom_segment(data=mdsvectors, aes(xend=0, yend=0, x=MDS1, y=MDS2), alpha = .6)+
    geom_segment(data=mdsvectors %>% top_n(8, distance), aes(xend=0, yend=0, x=MDS1, y=MDS2), alpha = 1) +
    geom_text(data=mdsvectors %>% top_n(8, distance), aes(x=MDS1, y=MDS2, label=Species), col="black", size=2.5, segment.colour = NA, box.padding = .2) +
   theme_classic()
```


### select traits
https://fukamilab.github.io/BIO202/06-B-constrained-ordination.html
```{r}
# create predictor data
# Check correlations, and avoid using predictors that are highly (un)correlated
library(corrplot)
adonis_meta_pver %>% 
  select(where(is.numeric)) %>%
cor %>%
corrplot(type = "upper", diag = F)
```
Reef and DHW and lat/long are aliases (interchangeable) 
lat/long are strongly correlated. we'll sector to represent geography



When one independent variable is highly correlated with another independent variable (or with a combination of
independent variables), the marginal contribution of that independent variable is influenced by other predictor
variables in the model. In this case, estimates for the regression coefficient of these variables can be unreliable
or misleading.

To check for multicolinearity problem in our model, we need the vif() function from the car package. vif()
calculates variance-inflation and generalized variance-inflation factors for linear, generalized linear, and other
models.It measures how much the variance of any one of the coefficients is inflated due to multicollinearity in
the overall model.

As a rule of thumb, a vif score over 5 is a problem. A score over 10 should be remedied and you should
consider dropping the problematic variable from the regression model or creating an index of all the closely
related variables.
Note: 3 corresponds to an R-square of .6 so ideally we want values that is less than 3.

```{r}
# Estimate VIF and plot
library(car) #for variance inflation factors
#Check for variance inflation among key predictors
vif(lm(1:nrow(adonis_meta_pver) ~ Sector + Morphotype + Aspect + Exposure + catBleaching + Depth + DHW + DHW6, data=adonis_meta_pver))
```
Most our traits appear to be independent from one another (<3) except for DHW and #events. We want to keep DHW but we can select one of DHW3,4,6,9 to represent bleaching history (I suggest DHW6).
Note I've remove geography (lat/long) as a predictor. If you were interested in this you would have to remove some predictors eg Sector and DHW.




We can  standardize the variables to zero mean and unit variance by adding argument scale = TRUE into the rda function. This standardisation ensures that each variable brings the same amount of variance into the analysis. This is important in the case that variables are each in very different units and have therefore very different variances.

```{r}
## Full model
RDAfull <- rda(pver.community.matrix %>% select(all_of(my.symbionts)) ~ Sector + Morphotype + Aspect + Exposure + catBleaching + Depth + DHW + DHW6,  data = adonis_meta_pver, scale = TRUE)

screeplot(RDAfull)
```
We can see that the first axis explains most of the variance in the data.


```{r}
# Test of all canonical axes
anova.cca(RDAfull, by='axis', step=99)

# canonical coefficients
as.data.frame(coef(RDAfull)) %>% rownames_to_column() %>% 
  select(rowname, RDA1) %>% arrange(desc(RDA1)) 
```
Only RDA1 is important.
          Df Variance      F Pr(>F)  
RDA1       1    6.737 4.6093  0.011 *


```{r}
summary(RDAfull)
```

Partitioning of correlations:
              Inertia Proportion
Total          40.000     1.0000
Constrained     6.229     0.1557
Unconstrained  33.771     0.8443

The *constrained* is the amount of variance the community matrix is explained by the explanatory variables (expressed as a proportion). Here, our predictors explain 15.6% of the data, and 84.4% of variance is unexplained (*unconstrained*). I suspect this is driven largely by 1 or 2 predictors.


```{r}
# adjusted R^2
R2adj <- RsquareAdj(RDAfull)$adj.r.squared
R2adj 
```
The adjusted R2 measures the unbiased amount of explained variation. So this model explains 4% of the variation in the data. If you used the biased R2, any variable included in the explanatory responses would increase the R2, so the R2 needs to be adjusted for the number of explanatory variables (especially since we have eight included here).


```{r}
plot(RDAfull, scaling=1, main="Triplot RDA matrix ~ env - scaling 1 - wa scores")

# arrows for species are missing, so lets add them without heads so they look different than the explanatory variables
spe.sc <- scores(RDAfull, choices=1:2, scaling=1, display="sp")
arrows(0,0,spe.sc[,1], spe.sc[,2], length=0, lty=1, col='red')
```




```{r}
## Model geography
pRDA1 <- rda(pver.community.matrix %>% select(all_of(my.symbionts)) ~ Sector + Aspect + Exposure + Depth + Condition(Morphotype  + catBleaching + DHW + DHW6),  data = adonis_meta_pver, scale = TRUE)
anova(pRDA1)
pRDA1
RsquareAdj(pRDA1)

## Model bleaching
pRDA2 <- rda(pver.community.matrix %>% select(all_of(my.symbionts)) ~ catBleaching + DHW + Condition(Sector + Morphotype + Aspect + Exposure + Depth + DHW6),  data = adonis_meta_pver, scale = TRUE)
anova(pRDA2)
pRDA2
RsquareAdj(pRDA2)

## Model climate history
pRDA3 <- rda(pver.community.matrix %>% select(all_of(my.symbionts)) ~ DHW6 + Condition(Sector + Morphotype + Aspect + Exposure + catBleaching + Depth + DHW),  data = adonis_meta_pver, scale = TRUE)
anova(pRDA3)
pRDA3
RsquareAdj(pRDA3)
```







# ----------------------------------------------------------
Permanova/ PCoA: Pocillopora meandrina 
# ----------------------------------------------------------

```{r}
#importing unifrac distances for analysis 
dist_pmea <- as.dist(du_pmea, diag = FALSE)

dim(du_pmea)

# Sanity check
full_meta2$plate_position %in% rownames(du_pmea)

adonis_meta_pmea <- full_meta2 %>%
  dplyr::select(plate_position, Reef, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, recent.maxDHW, maxDHW, meanDHW) %>%
  filter(plate_position %in% rownames(du_pmea)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res <- adonis(dist_pmea ~ meanDHW, data = adonis_meta_pmea)

test_pmea <- betadisper(as.dist(du_pmea), adonis_meta_pmea$meanDHW)
plot(test_pmea)
anova(test_pmea)
```



# ----------------------------------------------------------
3.2a Permanova/ PCoA: Acropora 
# ----------------------------------------------------------

```{r}
#importing unifrac distances for analysis 
dist_acro <- as.dist(du_acro, diag = FALSE)

dim(du_acro)

# Sanity check
full_meta2$plate_position %in% rownames(du_acro)

adonis_meta_acro <- full_meta2 %>%
  select(plate_position, Reef, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3) %>%
  filter(plate_position %in% rownames(du_acro)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res_acro <- adonis(dist_acro ~ DHW3, data = adonis_meta_acro)


test_acro <- betadisper(as.dist(du_acro), adonis_meta_acro$DHW3)
plot(test_acro)
anova(test_acro)
```


## 3.2b PCoA plot for Acropora 
```{r}
pcoares_acro <- pcoa(dist_acro)
            
pcoa_df_acro <- as.data.frame(pcoares_acro$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_acro %>% rownames_to_column(var = "plate_position")) %>% 
    mutate(Reef = fct_relevel(Reef, c("Osprey", "Bougainville", "Moore", "Willis", "Holmes", "Chilcott", "Herald", "Lihou", "Flinders", "Marion", "Frederick", "Saumarez", "Wreck")))

ggplot(pcoa_df_acro, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Reef), shape = 21, size = 3, alpha = 0.8) +
  facet_wrap(~Reef) +
  ggalt::geom_encircle(aes(group = Reef, fill = Reef), s_shape=1, expand=0, alpha = 0.1) +
  theme_classic()

ggsave("AcroPCA.png", height = 7, width = 12)
```






**Extras ** Saving for now but might be able to delete 

##a. Permanova / Betadisper 
```{r}
#importing unifrac distances for analysis 
dist_poci <- as.dist(du_poci, diag = FALSE)

dim(du_poci)

# Sanity check
full_meta2$plate_position %in% rownames(du_poci)

adonis_meta_poci <- full_meta2 %>%
  dplyr::select(plate_position, Reef, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4) %>%
  filter(plate_position %in% rownames(du_poci)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res <- adonis(dist_poci ~ Reef, data = adonis_meta_poci)

test_poci <- betadisper(as.dist(du_poci), adonis_meta_poci$Reef)
plot(test_poci)
anova(test_poci)
```

## 3b. PCoA plot
```{r}
pcoares_poci <- pcoa(dist_poci)
            
pcoa_df_poci <- as.data.frame(pcoares_poci$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  dplyr::select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_poci %>% rownames_to_column(var = "plate_position")) %>%
  mutate(Reef = fct_relevel(Reef, c("Osprey", "Bougainville", "Moore", "Willis", "Holmes", "Chilcott", "Herald", "Lihou", "Flinders", "Marion", "Frederick", "Saumarez", "Wreck")))

pcoa_poci <- ggplot(pcoa_df_poci, aes(Axis.1, Axis.2)) +
  geom_point(aes(shape = Species, fill = Species), size = 2, alpha = 0.8) +
  facet_wrap(~Reef) +
  ggalt::geom_encircle(aes(group = Reef, colour = Reef), s_shape=1, expand=0, alpha = 0.5) +
  scale_shape_manual(values = c(21,22,23)) +
  scale_color_d3(palette = "category20") +
  theme_classic()

ggsave("pcoa_poci.png", dpi =300, width=185, height=110, units = "mm")
```


#3c idea to plot the clustering, and colour by a factor **Pocillopora all species**
```{r}
library(reshape2)
k_poci <- kmeans(dist_poci, centers = 3)

kdf_poci <- enframe(k_poci$cluster) %>%
  select(name, k = value)

du_k_poci <- reshape2::melt(du_poci) %>%
        select(from = Var1, to = Var2, value) %>% 
          left_join(., kdf_poci, by = c("from" = "name")) %>%
            left_join(., kdf_poci, by = c("to" = "name"))

du_1_poci <- du_k_poci %>%
  filter(k.x == 2 & k.y == 2) %>%
  acast(from ~ to)

adonis_meta_poci <- full_meta2 %>%
  select(plate_position, Site, catBleaching, Species, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, Reef, DHW3, DHW4, DHW6, DHW9) %>%
  filter(plate_position %in% rownames(du_1_poci)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth))

adonis(du_1_poci ~ Reef + Species, data = adonis_meta_poci)

pcoares_poci <- pcoa(du_1_poci)

pcoa_df_poci <- as.data.frame(pcoares_poci$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  left_join(., adonis_meta_poci %>% rownames_to_column(var = "plate_position"))

ggplot(pcoa_df_poci, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Species), shape = 21, size = 3, alpha = 0.8) #+
 # scale_fill_viridis_c()
```



