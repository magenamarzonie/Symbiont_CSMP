---
title: "3_Acro_Pocillo_PCA"
author: "Magena Marzonie"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries 
```{r}
library(vegan)
library(ggsci)
library(tidyverse)
library(kmer)
library(phangorn)
library(GUniFrac)
library(ggtree)
library(patchwork)
library(bioseq)
library(ape)
library(Biostrings)
select = dplyr::select
```

#Load data 
```{r}
#load environmental data 
load("Data/SiteDisturbanceHistory_DHW.RData")
load("Data/SiteDisturbanceHistory_DHW.RData")

#load seq data from 2_UPGMA
load("Data/du_acro.RData")
load("Data/du_poci.RData")
load("Data/du_pver.Rdata")
load("Data/du_pmea.Rdata")
load("Data/du_punk.Rdata")
load("Data/full_meta.RData")
load("Data/full_meta2.RData")
```

#Data Wrangle 
```{r}
#Combining symbiont unifrac distances and environmental metadata
full_meta2 = full_meta2 %>% 
  mutate(DHW = as.numeric(DHW),
         Reef = as.factor(Reef.x),
         Site = as.factor(Site),
         Exposure = as.factor(Exposure),
         catBleaching = as.factor(catBleaching),
         Aspect = as.factor(Aspect))
```

# ----------------------------------------------------------
Permanova/ PCoA: **Pocillopora verrucosa**
# ----------------------------------------------------------

Workflow for each host species: 
1) Test VIF scores and remove any with VIF score > 3 
2) Unconstrained dbRDA to test all environmental factors 
3) Select environmental variables of interest 
4) Run constrained dbRDA on important enviro factors
5) Plot constrained dbRDA using either nMDS or PCoA 


**P. verrucosa**
```{r}
#importing unifrac distances for analysis 
dist_pver <- as.dist(du_pver, diag = FALSE)
dim(du_pver)

adonis_meta_pver <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, 
                catBleaching, Depth, DHW, GPS_S = `GPS south`, 
                GPS_E = `GPS east`, Aspect, Exposure, maxDHW, 
                meanDHW, recent.maxDHW, recent.meanDHW, DHW2, 
                DHW3, DHW4, DHW6, DHW8, DHW9, returnDHW3, returnDHW4, 
                returnDHW6, rangeSST, varSST, MMM) %>%
  filter(plate_position %in% rownames(du_pver)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

# NOTE: Need to make sure there are no alias factors. E.g. exposure is an alias of Reef (e.g. all Marion = Exposed, Site and Reef contain aliases, DHW2 == DHW3, etc)


# Make a correlation matrix of numeric variables
cm_pver <- cor(adonis_meta_pver %>% select(Depth, maxDHW, meanDHW, recent.maxDHW, 
                                      recent.meanDHW, DHW3, DHW4, DHW6, DHW8, 
                                      DHW9, rangeSST, varSST, MMM, GPS_S))
library(corrplot)
corrplot(cm_pver) # Clearly a lot of the DHW terms are positively related and approaching redundant

# Check the vif scores of the full model
ord_pver_full <- dbrda(dist_pver ~  Depth + maxDHW + meanDHW + recent.maxDHW + recent.meanDHW + DHW3 + DHW4 + DHW6 + DHW8 + DHW9 + rangeSST + varSST + MMM + GPS_S, data=adonis_meta_pver)
sort(vif.cca(ord_pver_full)) 
# according to vif.cca documentation, values over 10 indicate redundant constraints
    #      Depth           DHW6           DHW3  recent.maxDHW           DHW8         maxDHW           DHW9           DHW4        meanDHW       rangeSST 
    #   1.513119       8.139152       9.269449      10.521798      10.882881      15.392102      21.143380      30.863009      58.925047      65.211384 
    #     varSST          GPS_S recent.meanDHW            MMM 
    # 134.792127     188.566323     190.258298     418.940058

# Reduce the model (consult the corplot and vif scores)
ord_pver <- dbrda(dist_pver ~ Depth + DHW3 + DHW6 + recent.maxDHW + rangeSST + GPS_S, data=adonis_meta_pver)

# Re check the new vif scores
sort(vif.cca(ord_pver))
# Depth          DHW3          DHW6 recent.maxDHW         GPS_S      rangeSST 
#      1.101216      1.298297      1.520353      1.705474      1.722712      2.315683 

# Use ordistep to further refine the model
os_pver_backward <- ordistep(ord_pver, direction = "backward", trace = FALSE)
anova(os_pver_backward, by = 'margin')

pver_scores <- as.data.frame(scores(os_pver_backward, display = "sites")) %>%
  tibble::rownames_to_column(var = "plate_position") %>%
  left_join(., adonis_meta_pver %>% tibble::rownames_to_column(var = "plate_position"))

pver_vectors <- as.data.frame(os_pver_backward$CCA$biplot) %>%
  tibble::rownames_to_column(var = "factors")

ggplot(pver_scores, aes(x = dbRDA1, y = dbRDA2)) +
  geom_point(aes(fill = DHW3), size = 4, shape = 21) +
  #geom_encircle(aes(group = k), fill = "grey50", s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
  geom_text(data = pver_vectors, aes(x = dbRDA1, y = dbRDA2, label = factors), size = 4) +
  geom_segment(data = pver_vectors, aes(x = 0, xend = dbRDA1, y = 0, yend = dbRDA2), size = 0.5, arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  theme(legend.position = "right", aspect.ratio = 1) +
  scale_fill_viridis_c(option = "magma")

plot(os_pver_backward)

#forward model does not take collinearity into account, as you can see by 7 predictors (many of which likely have high VIF scores)
#both will default to 'backward' if scope is not defined in model

```
```{r}
corrplot(cm_pver)
```


**P. meandrina** 
```{r}
#importing unifrac distances for analysis 
dist_pmea <- as.dist(du_pmea, diag = FALSE)
dim(du_pmea)

adonis_meta_pmea <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, 
                catBleaching, Depth, DHW, GPS_S = `GPS south`, 
                GPS_E = `GPS east`, Aspect, Exposure, maxDHW, 
                meanDHW, recent.maxDHW, recent.meanDHW, DHW2, 
                DHW3, DHW4, DHW6, DHW8, DHW9, returnDHW3, returnDHW4, 
                returnDHW6, rangeSST, varSST, MMM) %>%
  filter(plate_position %in% rownames(du_pmea)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

# NOTE: Need to make sure there are no alias factors. E.g. exposure is an alias of Reef (e.g. all Marion = Exposed, Site and Reef contain aliases, DHW2 == DHW3, etc)

# Make a correlation matrix of numeric variables
cm <- cor(adonis_meta_pmea %>% select(Depth, maxDHW, meanDHW, recent.maxDHW, 
                                      recent.meanDHW, DHW3, DHW4, DHW6, DHW8, 
                                      DHW9, rangeSST, varSST, MMM, GPS_S))
library(corrplot)
corrplot(cm) # Clearly a lot of the DHW terms are positively related and approaching redundant

# Check the vif scores of the full model
ord_pmea_full <- dbrda(dist_pmea ~ Depth + maxDHW + meanDHW + recent.maxDHW + recent.meanDHW + DHW3 + DHW4 + DHW6 + DHW8 + DHW9 + rangeSST + varSST + MMM + GPS_S, data=adonis_meta_pmea)
sort(vif.cca(ord_pmea_full)) 
# Depth           DHW4           DHW6           DHW9           DHW8         maxDHW           DHW3  recent.maxDHW        meanDHW       rangeSST recent.meanDHW         varSST 
#       1.961623       5.524548       6.432968      10.005341      10.535683      11.883727      12.147581      13.755357      56.646502      67.138168     133.177017     155.900084 
#          GPS_S            MMM 
#     216.759822     414.329321  

# Reduce the model (consult the corplot and vif scores)
ord_pmea <- dbrda(dist_pmea ~ Depth + DHW3 + DHW6 + recent.maxDHW + varSST + GPS_S, data = adonis_meta_pmea)

# Re check the new vif scores
sort(vif.cca(ord_pmea))
# Depth          DHW3 recent.maxDHW      rangeSST          DHW6         GPS_S 
#      1.420261      1.550909      2.024239      2.425726      3.050987      3.653113 

# Use ordistep to further refine the model
os_pmea_backward <- ordistep(ord_pmea, direction = "backward")
anova(os_pmea_backward, by = 'margin')

pmea_scores <- as.data.frame(scores(os_pmea_backward, display = "sites")) %>%
  tibble::rownames_to_column(var = "plate_position") %>%
  left_join(., adonis_meta_pmea %>% tibble::rownames_to_column(var = "plate_position"))

pmea_vectors <- as.data.frame(os_pmea_backward$CCA$biplot) %>%
  tibble::rownames_to_column(var = "factors")

ggplot(pmea_scores, aes(x = dbRDA1, y = dbRDA2)) +
  geom_point(aes(fill = GPS_S), size = 4, shape = 21) +
  #ggalt::geom_encircle(aes(group = Reef.x), fill = "grey50", s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
  #facet_wrap(~Reef.x) +
  geom_text(data = pmea_vectors, aes(x = dbRDA1, y = dbRDA2, label = factors), size = 4) +
  geom_segment(data = pmea_vectors, aes(x = 0, xend = dbRDA1, y = 0, yend = dbRDA2), size = 0.5, arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  theme(legend.position = "right", aspect.ratio = 1) +
  scale_fill_viridis_c(option = "magma")

plot(os_pmea_backward)
```
**A. humilis**

```{r}
#importing unifrac distances for analysis 
dist_acro <- as.dist(du_acro, diag = FALSE)
dim(du_acro)

adonis_meta_acro <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, 
                catBleaching, Depth, DHW, GPS_S = `GPS south`, 
                GPS_E = `GPS east`, Aspect, Exposure, maxDHW, 
                meanDHW, recent.maxDHW, recent.meanDHW, DHW2, 
                DHW3, DHW4, DHW6, DHW8, DHW9, returnDHW3, returnDHW4, 
                returnDHW6, rangeSST, varSST, MMM) %>%
  filter(plate_position %in% rownames(du_acro)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

# NOTE: Need to make sure there are no alias factors. E.g. exposure is an alias of Reef (e.g. all Marion = Exposed, Site and Reef contain aliases, DHW2 == DHW3, etc)


# Make a correlation matrix of numeric variables
cm_acro <- cor(adonis_meta_acro %>% select(Depth, maxDHW, meanDHW, recent.maxDHW, 
                                      recent.meanDHW, DHW3, DHW4, DHW6, DHW8, 
                                      DHW9, rangeSST, varSST, MMM, GPS_S))
library(corrplot)
corrplot(cm_acro) # Clearly a lot of the DHW terms are positively related and approaching redundant

# Check the vif scores of the full model
ord_acro_full <- dbrda(dist_acro ~  Depth + maxDHW + meanDHW + recent.maxDHW + recent.meanDHW + DHW3 + DHW4 + DHW6 + DHW8 + DHW9 + rangeSST + varSST + MMM + GPS_S, data=adonis_meta_acro)
sort(vif.cca(ord_acro_full)) 
# according to vif.cca documentation, values over 10 indicate redundant constraints
    #  Depth           DHW6           DHW8           DHW3           DHW4           DHW9 
    #   1.602809       5.019220       6.170613       7.151695       8.330065      13.456450 
    #     maxDHW  recent.maxDHW        meanDHW recent.meanDHW       rangeSST         varSST 
    #  15.191953      15.506837      28.891993     113.987710     155.276867     179.948250 
    #      GPS_S            MMM 
    # 735.291524     780.690427 

# Reduce the model (consult the corplot and vif scores)
ord_acro <- dbrda(dist_acro ~ Depth + maxDHW + DHW3 + DHW6 + recent.maxDHW + varSST + GPS_S , data=adonis_meta_acro)

# Re check the new vif scores
sort(vif.cca(ord_acro))

# Use ordistep to further refine the model
os_acro_backward <- ordistep(ord_acro, direction = "backward", trace = FALSE)
anova(os_acro_backward, by = 'margin')


acro_scores <- as.data.frame(scores(os_acro_backward, display = "sites")) %>%
  tibble::rownames_to_column(var = "plate_position") %>%
  left_join(., adonis_meta_acro %>% tibble::rownames_to_column(var = "plate_position"))

acro_vectors <- as.data.frame(os_acro_backward$CCA$biplot) %>%
  tibble::rownames_to_column(var = "factors")

ggplot(acro_scores, aes(x = dbRDA1, y = dbRDA2)) +
  geom_point(aes(fill = GPS_S), size = 4, shape = 21) +
  #ggalt::geom_encircle(aes(group = Reef.x), fill = "grey50", s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
  #facet_wrap(~Reef.x) +
  geom_text(data = acro_vectors, aes(x = dbRDA1, y = dbRDA2, label = factors), size = 4) +
  geom_segment(data = acro_vectors, aes(x = 0, xend = dbRDA1, y = 0, yend = dbRDA2), size = 0.5, arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  theme(legend.position = "right", aspect.ratio = 1) +
  scale_fill_viridis_c(option = "magma")

plot(os_acro_backward)
```



```{r}
#importing unifrac distances for analysis 
dist_punk <- as.dist(du_punk, diag = FALSE)
dim(du_punk)

adonis_meta_punk <- full_meta2 %>%
  dplyr::select(plate_position, Sector, Reef.x, Site, Species, 
                catBleaching, Depth, DHW, GPS_S = `GPS south`, 
                GPS_E = `GPS east`, Aspect, Exposure, maxDHW, 
                meanDHW, recent.maxDHW, recent.meanDHW, DHW2, 
                DHW3, DHW4, DHW6, DHW8, DHW9, returnDHW3, returnDHW4, 
                returnDHW6, rangeSST, varSST, MMM) %>%
  filter(plate_position %in% rownames(du_punk)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(sample_name = rownames(.))

# NOTE: Need to make sure there are no alias factors. E.g. exposure is an alias of Reef (e.g. all Marion = Exposed, Site and Reef contain aliases, DHW2 == DHW3, etc)


# Make a correlation matrix of numeric variables
cm_punk <- cor(adonis_meta_punk %>% select(Depth, maxDHW, meanDHW, recent.maxDHW, 
                                      recent.meanDHW, DHW3, DHW4, DHW6, DHW8, 
                                      DHW9, rangeSST, varSST, MMM, GPS_S))
library(corrplot)
corrplot(cm_punk) # Clearly a lot of the DHW terms are positively related and approaching redundant

# Check the vif scores of the full model
ord_punk_full <- dbrda(dist_punk ~  Depth + maxDHW + meanDHW + recent.maxDHW + recent.meanDHW + DHW3 + DHW4 + DHW6 + DHW8 + DHW9 + rangeSST + varSST + MMM + GPS_S, data=adonis_meta_punk)
sort(vif.cca(ord_punk_full)) 
# according to vif.cca documentation, values over 10 indicate redundant constraints
    #  Depth           DHW6           DHW8           DHW3           DHW4           DHW9 
    #   1.602809       5.019220       6.170613       7.151695       8.330065      13.456450 
    #     maxDHW  recent.maxDHW        meanDHW recent.meanDHW       rangeSST         varSST 
    #  15.191953      15.506837      28.891993     113.987710     155.276867     179.948250 
    #      GPS_S            MMM 
    # 735.291524     780.690427 

# Reduce the model (consult the corplot and vif scores)
ord_punk <- dbrda(dist_punk ~ Depth + maxDHW + DHW3 + DHW6 + recent.maxDHW + varSST + GPS_S , data=adonis_meta_punk)

# Re check the new vif scores
sort(vif.cca(ord_punk))

# Use ordistep to further refine the model
os_punk_backward <- ordistep(ord_punk, direction = "backward", trace = FALSE)
anova(os_punk_backward, by = 'margin')


punk_scores <- as.data.frame(scores(os_punk_backward, display = "sites")) %>%
  tibble::rownames_to_column(var = "plate_position") %>%
  left_join(., adonis_meta_punk %>% tibble::rownames_to_column(var = "plate_position"))

punk_vectors <- as.data.frame(os_punk_backward$CCA$biplot) %>%
  tibble::rownames_to_column(var = "factors")

ggplot(punk_scores, aes(x = dbRDA1, y = dbRDA2)) +
  geom_point(aes(fill = GPS_S), size = 4, shape = 21) +
  #ggalt::geom_encircle(aes(group = Reef.x), fill = "grey50", s_shape = 1, expand = 0, alpha = 0.2, show.legend = FALSE) +
  #facet_wrap(~Reef.x) +
  geom_text(data = punk_vectors, aes(x = dbRDA1, y = dbRDA2, label = factors), size = 4) +
  geom_segment(data = punk_vectors, aes(x = 0, xend = dbRDA1, y = 0, yend = dbRDA2), size = 0.5, arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  theme(legend.position = "right", aspect.ratio = 1) +
  scale_fill_viridis_c(option = "magma")

plot(os_punk_backward)
```


