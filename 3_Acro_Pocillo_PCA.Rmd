---
title: "3_Acro_Pocillo_PCA"
author: "Magena Marzonie"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries 
```{r}
library(vegan)
select = dplyr::select
```

```{r}
#load environmental data 
load("Data/SiteDisturbanceHistory_DHW.RData")

#load seq data from 2_UPGMA
load("Data/du_acro.RData")
load("Data/du_poci.RData")
load("Data/full_meta.RData")
```


## 3.1a Permanova Pocillopora 
```{r}
#importing unifrac distances for analysis 
dist_poci <- as.dist(du_poci, diag = FALSE)

dim(du_poci)

# Sanity check
full_meta$plate_position %in% rownames(du_poci)

adonis_meta_poci <- full_meta %>%
  dplyr::select(plate_position, Reef, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure) %>%
  filter(plate_position %in% rownames(du_poci)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res <- adonis(dist_poci ~ Reef, data = adonis_meta_poci)

test_poci <- betadisper(as.dist(du_poci), adonis_meta_poci$Reef)
plot(test_poci)
anova(test_poci)
```
#Colour dots by species 
#Are outliers meaningful - what's in those communities that makes them different 
# separate into 2 poci species 
# re-evaluate those enviro variables 
# add in thermal history variables 

## 3.1b PCoA plot for Pocillopora 
```{r}
pcoares_poci <- pcoa(dist_poci)
            
pcoa_df_poci <- as.data.frame(pcoares_poci$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  dplyr::select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_poci %>% rownames_to_column(var = "plate_position"))

ggplot(pcoa_df_poci, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Reef), shape = 21, size = 3, alpha = 0.8) +
  ggalt::geom_encircle(aes(group = Reef, fill = Reef), s_shape=1, expand=0, alpha = 0.1) 
```




#3.1c idea to plot the clustering, and colour by a factor
```{r}
library(reshape2)
k_poci <- kmeans(dist_poci, centers = 3)

kdf_poci <- enframe(k_poci$cluster) %>%
  select(name, k = value)

du_k_poci <- reshape2::melt(du_poci) %>%
        select(from = Var1, to = Var2, value) %>% 
          left_join(., kdf_poci, by = c("from" = "name")) %>%
            left_join(., kdf_poci, by = c("to" = "name"))

du_1_poci <- du_k_poci %>%
  filter(k.x == 2 & k.y == 2) %>%
  acast(from ~ to)

adonis_meta_poci <- full_meta %>%
  select(plate_position, Reef, Site, catBleaching, Species, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure) %>%
  filter(plate_position %in% rownames(du_1_poci)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth))

adonis(du_1_poci ~ Reef + Species, data = adonis_meta_poci)

pcoares_poci <- pcoa(du_1_poci)

pcoa_df_poci <- as.data.frame(pcoares_poci$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  left_join(., adonis_meta_poci %>% rownames_to_column(var = "plate_position"))

ggplot(pcoa_df_poci, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Species), shape = 21, size = 3, alpha = 0.8) #+
 # scale_fill_viridis_c()
```



# ----------------------------------------------------------


3.2a Permanova: Acropora 
```{r}
#importing unifrac distances for analysis 
dist_acro <- as.dist(du_acro, diag = FALSE)

dim(du_acro)

# Sanity check
full_meta$plate_position %in% rownames(du_acro)

adonis_meta_acro <- full_meta %>%
  select(plate_position, Reef, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure) %>%
  filter(plate_position %in% rownames(du_acro)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res_acro <- adonis(dist_acro ~ Reef, data = adonis_meta_acro)
res_acro <- adonis(dist_acro ~ GPS_S, data = adonis_meta_acro)


test_acro <- betadisper(as.dist(du_acro), adonis_meta_acro$GPS_S)
plot(test_acro)
anova(test_acro)
```


## 3.2b PCoA plot for Acropora 
```{r}
pcoares_acro <- pcoa(dist_acro)
            
pcoa_df_acro <- as.data.frame(pcoares_acro$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_acro %>% rownames_to_column(var = "plate_position"))

ggplot(pcoa_df_acro, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Reef), shape = 21, size = 3, alpha = 0.8) +
  ggalt::geom_encircle(aes(group = Reef, fill = Reef), s_shape=1, expand=0, alpha = 0.1) 
```



