---
title: "3_Acro_Pocillo_PCA"
author: "Magena Marzonie"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries 
```{r}
library(vegan)
library(ggsci)
library(tidyverse)
library(kmer)
library(phangorn)
library(GUniFrac)
library(ggtree)
library(patchwork)
library(bioseq)
library(ape)
library(Biostrings)
select = dplyr::select
```

#Load data 
```{r}
#load environmental data 
load("Data/SiteDisturbanceHistory_DHW.RData")

#load seq data from 2_UPGMA
load("Data/du_acro.RData")
load("Data/du_poci.RData")
load("Data/du_pver.Rdata")
load("Data/du_pmea.Rdata")
load("Data/du_punk.Rdata")
load("Data/full_meta.RData")
```

#Merge enviro and symbiont metadata 
```{r}
#change site names so they will merge with full_meta 
full_meta2 = full_meta %>% left_join(site.bleachings, by = "Site")
```


# ----------------------------------------------------------
Permanova/ PCoA: **Pocillopora all species**
# ----------------------------------------------------------

##a. Permanova / Betadisper 
```{r}
#importing unifrac distances for analysis 
dist_poci <- as.dist(du_poci, diag = FALSE)

dim(du_poci)

# Sanity check
full_meta2$plate_position %in% rownames(du_poci)

adonis_meta_poci <- full_meta2 %>%
  dplyr::select(plate_position, Reef.x, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4) %>%
  filter(plate_position %in% rownames(du_poci)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res <- adonis(dist_poci ~ Reef.x, data = adonis_meta_poci)

test_poci <- betadisper(as.dist(du_poci), adonis_meta_poci$Reef.x)
plot(test_poci)
anova(test_poci)
```

## 3b. PCoA plot
```{r}
pcoares_poci <- pcoa(dist_poci)
            
pcoa_df_poci <- as.data.frame(pcoares_poci$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  dplyr::select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_poci %>% rownames_to_column(var = "plate_position")) %>%
  mutate(Reef.x = fct_relevel(Reef.x, c("Osprey", "Bougainville", "Moore", "Willis", "Holmes", "Chilcott", "Herald", "Lihou", "Flinders", "Marion", "Frederick", "Saumarez", "Wreck")))

pcoa_poci <- ggplot(pcoa_df_poci, aes(Axis.1, Axis.2)) +
  geom_point(aes(shape = Species, fill = Species), size = 2, alpha = 0.8) +
  facet_wrap(~Reef.x) +
  ggalt::geom_encircle(aes(group = Reef.x, colour = Reef.x), s_shape=1, expand=0, alpha = 0.5) +
  scale_shape_manual(values = c(21,22,23)) +
  scale_color_d3(palette = "category20") +
  theme_classic()

ggsave("pcoa_poci.png", dpi =300, width=185, height=110, units = "mm")
```


#3c idea to plot the clustering, and colour by a factor **Pocillopora all species**
```{r}
library(reshape2)
k_poci <- kmeans(dist_poci, centers = 3)

kdf_poci <- enframe(k_poci$cluster) %>%
  select(name, k = value)

du_k_poci <- reshape2::melt(du_poci) %>%
        select(from = Var1, to = Var2, value) %>% 
          left_join(., kdf_poci, by = c("from" = "name")) %>%
            left_join(., kdf_poci, by = c("to" = "name"))

du_1_poci <- du_k_poci %>%
  filter(k.x == 2 & k.y == 2) %>%
  acast(from ~ to)

adonis_meta_poci <- full_meta2 %>%
  select(plate_position, Site, catBleaching, Species, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, Reef.x, DHW3, DHW4, DHW6, DHW9) %>%
  filter(plate_position %in% rownames(du_1_poci)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth))

adonis(du_1_poci ~ Reef.x + Species, data = adonis_meta_poci)

pcoares_poci <- pcoa(du_1_poci)

pcoa_df_poci <- as.data.frame(pcoares_poci$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  left_join(., adonis_meta_poci %>% rownames_to_column(var = "plate_position"))

ggplot(pcoa_df_poci, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Species), shape = 21, size = 3, alpha = 0.8) #+
 # scale_fill_viridis_c()
```



# ----------------------------------------------------------
Permanova/ PCoA: **Pocillopora verrucosa**
# ----------------------------------------------------------

## a Permanova/ Betadisper 
```{r}
#importing unifrac distances for analysis 
dist_pver <- as.dist(du_pver, diag = FALSE)

dim(du_pver)

# Sanity check
full_meta2$plate_position %in% rownames(du_pver)

adonis_meta_pver <- full_meta2 %>%
  dplyr::select(plate_position, Reef.x, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, DHW6, DHW9) %>%
  filter(plate_position %in% rownames(du_pver)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res <- adonis(dist_pver ~ Reef.x, data = adonis_meta_pver)

test_pver <- betadisper(as.dist(du_pver), adonis_meta_pver$Reef.x)
plot(test_pver)
anova(test_pver)
```

##b. PCoA 
```{r}
pcoares_pver <- pcoa(dist_pver)
            
pcoa_df_pver <- as.data.frame(pcoares_pver$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  dplyr::select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_poci %>% rownames_to_column(var = "plate_position")) %>%
    mutate(Reef.x = fct_relevel(Reef.x, c("Osprey", "Bougainville", "Moore", "Willis", "Holmes", "Chilcott", "Herald", "Lihou", "Flinders", "Marion", "Frederick", "Saumarez", "Wreck")))


ggplot(pcoa_df_pver, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Reef.x), shape = 21, size = 3, alpha = 0.8) +
  facet_wrap(~Reef.x) +
  ggalt::geom_encircle(aes(group = Reef.x, fill = Reef.x), s_shape=1, expand=0, alpha = 0.1) 

#ggsave("fig/pcoa_df_poci.png", dpi =300, width=8, height=8, units = "cm")

```


# ----------------------------------------------------------
Permanova/ PCoA: Pocillopora meandrina 
# ----------------------------------------------------------

```{r}
#importing unifrac distances for analysis 
dist_pmea <- as.dist(du_pmea, diag = FALSE)

dim(du_pmea)

# Sanity check
full_meta2$plate_position %in% rownames(du_pmea)

adonis_meta_pmea <- full_meta2 %>%
  dplyr::select(plate_position, Reef.x, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3, DHW4, recent.maxDHW, maxDHW, meanDHW) %>%
  filter(plate_position %in% rownames(du_pmea)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res <- adonis(dist_pmea ~ meanDHW, data = adonis_meta_pmea)

test_pmea <- betadisper(as.dist(du_pmea), adonis_meta_pmea$meanDHW)
plot(test_pmea)
anova(test_pmea)
```




# ----------------------------------------------------------
3.2a Permanova/ PCoA: Acropora 
# ----------------------------------------------------------

```{r}
#importing unifrac distances for analysis 
dist_acro <- as.dist(du_acro, diag = FALSE)

dim(du_acro)

# Sanity check
full_meta2$plate_position %in% rownames(du_acro)

adonis_meta_acro <- full_meta2 %>%
  select(plate_position, Reef.x, Site, Species, catBleaching, Morphotype, Depth, DHW, GPS_S = `GPS south`, GPS_E = `GPS east`, Aspect, Exposure, DHW3) %>%
  filter(plate_position %in% rownames(du_acro)) %>%
  tibble::column_to_rownames(var = "plate_position") %>%
  mutate(depth_cat = round(Depth)) %>%
  mutate(sample_name = rownames(.))

res_acro <- adonis(dist_acro ~ DHW3, data = adonis_meta_acro)


test_acro <- betadisper(as.dist(du_acro), adonis_meta_acro$DHW3)
plot(test_acro)
anova(test_acro)
```


## 3.2b PCoA plot for Acropora 
```{r}
pcoares_acro <- pcoa(dist_acro)
            
pcoa_df_acro <- as.data.frame(pcoares_acro$vectors) %>%
  rownames_to_column(var = "plate_position") %>%
  select(plate_position, Axis.1:Axis.5) %>% 
  left_join(., adonis_meta_acro %>% rownames_to_column(var = "plate_position")) %>% 
    mutate(Reef.x = fct_relevel(Reef.x, c("Osprey", "Bougainville", "Moore", "Willis", "Holmes", "Chilcott", "Herald", "Lihou", "Flinders", "Marion", "Frederick", "Saumarez", "Wreck")))

ggplot(pcoa_df_acro, aes(Axis.1, Axis.2)) +
  geom_point(aes(fill = Reef.x), shape = 21, size = 3, alpha = 0.8) +
  facet_wrap(~Reef.x) +
  ggalt::geom_encircle(aes(group = Reef.x, fill = Reef.x), s_shape=1, expand=0, alpha = 0.1) +
  theme_classic()

ggsave("AcroPCA.png", height = 7, width = 12)
```



